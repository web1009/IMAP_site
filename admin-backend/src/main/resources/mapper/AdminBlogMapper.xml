<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.app.blog.mapper.AdminBlogMapper">

    <select id="selectBlogList"
            resultType="com.project.app.notice.dto.NoticeDto">
        SELECT
            cp.post_id      AS postId,
            cp.post_type   AS postType,
            cp.title       AS title,
            cp.subtitle    AS subtitle,
            cp.content     AS content,
            cp.writer_id   AS writerId,
            cp.writer_type AS writerType,
            cp.branch_id   AS branchId,
            cp.views       AS views,
            cp.is_visible  AS isVisible,
            cp.display_end AS displayEnd,
            cp.created_at  AS createdAt,
            cp.updated_at  AS updatedAt,
            ua.user_name   AS writerName,
            b.brch_nm      AS branchName
        FROM community_post cp
        LEFT JOIN users_admin ua ON cp.writer_id = ua.user_id
        LEFT JOIN branch b ON cp.branch_id = b.brch_id
        WHERE cp.post_type = 'BLOG'
        ORDER BY cp.created_at DESC
    </select>

    <select id="selectBlogDetail"
            parameterType="long"
            resultType="com.project.app.notice.dto.NoticeDto">
        SELECT
            cp.post_id      AS postId,
            cp.post_type   AS postType,
            cp.title       AS title,
            cp.subtitle    AS subtitle,
            cp.content     AS content,
            cp.writer_id   AS writerId,
            cp.writer_type AS writerType,
            cp.branch_id   AS branchId,
            cp.views       AS views,
            cp.is_visible  AS isVisible,
            cp.display_end AS displayEnd,
            cp.created_at  AS createdAt,
            cp.updated_at  AS updatedAt,
            ua.user_name   AS writerName,
            b.brch_nm      AS branchName
        FROM community_post cp
        LEFT JOIN users_admin ua ON cp.writer_id = ua.user_id
        LEFT JOIN branch b ON cp.branch_id = b.brch_id
        WHERE cp.post_id = #{postId}
          AND cp.post_type = 'BLOG'
    </select>

    <insert id="insertBlog"
            parameterType="com.project.app.notice.dto.NoticeDto"
            useGeneratedKeys="true"
            keyProperty="postId">
        INSERT INTO community_post
        ( post_type, title, subtitle, content, writer_id, writer_type, branch_id, views, is_visible, display_end, created_at, updated_at )
        VALUES
        ( #{postType}, #{title}, #{subtitle}, #{content}, #{writerId}, #{writerType}, #{branchId}, #{views}, #{isVisible}, #{displayEnd}, NOW(), NOW() )
    </insert>

    <update id="updateBlog"
            parameterType="com.project.app.notice.dto.NoticeDto">
        UPDATE community_post
        SET title = #{title}, subtitle = #{subtitle}, content = #{content}, branch_id = #{branchId}, display_end = #{displayEnd}, updated_at = NOW()
        WHERE post_id = #{postId} AND post_type = 'BLOG'
    </update>

    <update id="updateVisible">
        UPDATE community_post
        SET is_visible = #{visible}, updated_at = NOW()
        WHERE post_id = #{postId} AND post_type = 'BLOG'
    </update>

    <delete id="deleteBlog">
        DELETE FROM community_post
        WHERE post_id = #{postId} AND post_type = 'BLOG'
    </delete>
</mapper>
