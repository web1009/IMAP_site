<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.app.attendance.mapper.AttendanceMapper">

    <resultMap id="AttendeeRowMap" type="com.project.app.attendance.dto.AttendeeRow">
        <id property="reservationId" column="rsv_id" />
        <result property="userId" column="user_id" />
        <result property="userName" column="user_name" />
        <result property="phoneNumber" column="phone_number" />
        <result property="attendanceStatus" column="attendance_status" />
        <result property="rsvDt" column="rsv_dt" />
        <result property="rsvTime" column="rsv_time" />
    </resultMap>

    <!-- 참석자 = 해당 스케줄의 예약(reservation) 전부. 이용권 유무 관계없이 표시 -->
    <!-- attendance_status: 이용권 예약=pass_log, 일반 예약=reservation.attendance_status -->
    <select id="findAttendeesBySchdId" resultMap="AttendeeRowMap">
        SELECT
            r.rsv_id,
            r.user_id,
            u.user_name,
            u.phone_number,
            COALESCE(pl.attendance_status, r.attendance_status, 'UNCHECKED') AS attendance_status,
            DATE_FORMAT(r.rsv_dt, '%Y-%m-%d') AS rsv_dt,
            DATE_FORMAT(r.rsv_time, '%H:%i') AS rsv_time
        FROM reservation r
        INNER JOIN users u ON r.user_id = u.user_id
        LEFT JOIN pass_log pl ON pl.user_pass_id = r.user_pass_id AND pl.schd_id = r.schd_id
        WHERE r.schd_id = #{schdId}
          AND r.stts_cd IN ('CONFIRMED', 'PENDING')
        ORDER BY r.rsv_id
    </select>

    <!-- rsv_id로 해당 예약의 pass_log_id 조회 (이용권 예약이면 1건, 없으면 0) -->
    <select id="findPassLogIdByRsvId" resultType="java.lang.Long">
        SELECT pl.pass_log_id
        FROM reservation r
        INNER JOIN pass_log pl ON pl.user_pass_id = r.user_pass_id AND pl.schd_id = r.schd_id
        WHERE r.rsv_id = #{rsvId}
        LIMIT 1
    </select>

    <!-- 출석 체크: pass_log에 기록이 있으면 pass_log 업데이트 -->
    <update id="updatePassLogAttendance">
        UPDATE pass_log
        SET attendance_status = #{status}
        WHERE pass_log_id = #{passLogId}
    </update>

    <!-- 출석 체크: 이용권 없이 예약한 건은 reservation.attendance_status 업데이트 -->
    <update id="updateReservationAttendance">
        UPDATE reservation
        SET attendance_status = #{status}
        WHERE rsv_id = #{rsvId}
    </update>
</mapper>
