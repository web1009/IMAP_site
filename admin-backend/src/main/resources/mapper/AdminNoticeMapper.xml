<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.app.notice.mapper.AdminNoticeMapper">

    <!-- =========================
         공지사항 목록 조회 (ADMIN)
         - 숨김 여부 무관
         - post_type = NOTICE
    ========================= -->
    <select id="selectNoticeList"
            resultType="com.project.app.notice.dto.NoticeDto">

        SELECT
            cp.post_id,
            cp.post_type,
            cp.title,
            cp.content,
            cp.writer_id,
            cp.writer_type,
            cp.branch_id,
            cp.views,
            cp.is_visible,
            cp.display_end,
            cp.created_at,
            cp.updated_at,

            -- 작성자 / 지점 표시용
            ua.user_name AS writerName,
            b.brch_nm     AS branchName

        FROM community_post cp
        LEFT JOIN users_admin ua
               ON cp.writer_id = ua.user_id
        LEFT JOIN branch b
               ON cp.branch_id = b.brch_id

        WHERE cp.post_type = 'NOTICE'
        ORDER BY cp.created_at DESC

    </select>

    <!-- =========================
         공지사항 상세 조회 (ADMIN)
    ========================= -->
    <select id="selectNoticeDetail"
            parameterType="long"
            resultType="com.project.app.notice.dto.NoticeDto">

        SELECT
            cp.post_id,
            cp.post_type,
            cp.title,
            cp.content,
            cp.writer_id,
            cp.writer_type,
            cp.branch_id,
            cp.views,
            cp.is_visible,
            cp.display_end,
            cp.created_at,
            cp.updated_at,

            -- 작성자 / 지점 표시용
            ua.user_name AS writerName,
            b.brch_nm     AS branchName

        FROM community_post cp
        LEFT JOIN users_admin ua
               ON cp.writer_id = ua.user_id
        LEFT JOIN branch b
               ON cp.branch_id = b.brch_id

        WHERE cp.post_id = #{postId}
          AND cp.post_type = 'NOTICE'

    </select>

    <!-- =========================
         공지사항 등록 (ADMIN)
         - display_end : NULL이면 상시
    ========================= -->
    <insert id="insertNotice"
            parameterType="com.project.app.notice.dto.NoticeDto"
            useGeneratedKeys="true"
            keyProperty="postId">

        INSERT INTO community_post
        (
            post_type,
            title,
            content,
            writer_id,
            writer_type,
            branch_id,
            views,
            is_visible,
            display_end,
            created_at,
            updated_at
        )
        VALUES
        (
            #{postType},
            #{title},
            #{content},
            #{writerId},
            #{writerType},
            #{branchId},
            #{views},
            #{isVisible},
            #{displayEnd},
            NOW(),
            NOW()
        )

    </insert>

    <!-- =========================
         공지사항 수정 (ADMIN)
         - 종료 날짜 수정 가능
    ========================= -->
    <update id="updateNotice"
            parameterType="com.project.app.notice.dto.NoticeDto">

        UPDATE community_post
        SET
            title = #{title},
            content = #{content},
            branch_id = #{branchId},
            display_end = #{displayEnd},
            updated_at = NOW()
        WHERE post_id = #{postId}
          AND post_type = 'NOTICE'

    </update>

    <!-- =========================
         공지사항 숨김 / 보이기 (ADMIN)
         - is_visible만 사용
    ========================= -->
    <update id="updateVisible">

        UPDATE community_post
        SET
            is_visible = #{visible},
            updated_at = NOW()
        WHERE post_id = #{postId}
          AND post_type = 'NOTICE'

    </update>

    <!-- =========================
         공지사항 삭제 (ADMIN)
         - 실제 DELETE
    ========================= -->
    <delete id="deleteNotice">

        DELETE FROM community_post
        WHERE post_id = #{postId}
          AND post_type = 'NOTICE'

    </delete>

</mapper>
